<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MS IDP Demo</title>
    <script src="https://bitwiseshiftleft.github.io/sjcl/sjcl.js"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <section id="card">
        <h1>Login</h1>
        <div id="content">
            <p>Click the login button below:</p>
        </div>
        <button id="login">Login</button>
    </section>
    <script>
        let CLIENT_ID = "028b488f-5b11-4792-adcd-d76ec31a5a90";

        let loginButton = document.querySelector("#login").addEventListener('click', e => {
            let url = makeAuthUrl(CLIENT_ID);
            location.assign(url);
        });
        let card = document.querySelector("#card");
        let content = document.querySelector("#content");

        let url = new URL(location.href);
        if (url.searchParams.has("error")) {
            console.error(url.searchParams.get("error_description"));
        }

        function h(name, options, children) {
            let elem = document.createElement(name);
            if (options["class"]) options["class"].forEach(element => {
                elem.classList.append(element);
            });
            elem.append(...children);
            return elem;
        }

        const c = document.createTextNode;

        async function onLoad(graphClient) {
            let me = await graphClient.me();
            let org = await graphClient.organization();

            content.append(
                h("div", { "class": ["user"] }, [
                    h("p", c(me.displayName)),
                    h("p", c(me.userPrincipalName))
                ]),
                h("div", { "class": ["org"] }, [
                    h("p", c(org.displayName)),
                    h("p", c(org.id))
                ]),
            );
        }

        if (url.searchParams.has("code")) {
            onCallback(CLIENT_ID).then(onLoad);
        }
    </script>
</body>

</html>
